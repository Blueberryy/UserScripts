name: Update User Script Version

on:
  schedule:
    - cron: '0 0 * * *'  # 每天运行一次
  push:
    branches:
      - main

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: Checkout code
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}  # 使用你创建的 Token

      - name: Check if script file exists
        run: |
          script_file="Greasyfork Utility Toolkit.user.js"
          if [ ! -f "$script_file" ]; then
            echo "Script file not found: $script_file"
            exit 1
          fi
          echo "Script file found: $script_file"

      - name: Extract current version
        id: extract_version
        run: |
          current_version=$(grep -oP '(?<=// @version\s+)\d+\.\d+\.\d+\.\d+' "Greasyfork Utility Toolkit.user.js")
          echo "Current version: $current_version"
          
          if [ -z "$current_version" ]; then
            echo "Version number not found in the script file."
            exit 1
          fi

          IFS='.' read -r -a version_parts <<< "$current_version"
          ((version_parts[3]++))

          if [ "${version_parts[3]}" -ge 10 ]; then
            version_parts[3]=0
            ((version_parts[2]++))
          fi

          if [ "${version_parts[2]}" -ge 10 ]; then
            version_parts[2]=0
            ((version_parts[1]++))
          fi

          if [ "${version_parts[1]}" -ge 10 ]; then
            version_parts[1]=0
            ((version_parts[0]++))
          fi

          new_version="${version_parts[0]}.${version_parts[1]}.${version_parts[2]}.${version_parts[3]}"
          echo "New version: $new_version"
          
          echo "new_version=$new_version" >> $GITHUB_ENV

      - name: Update script version
        run: |
          script_file="Greasyfork Utility Toolkit.user.js"
          sed -i "s|// @version\s\+[0-9]*\.[0-9]*\.[0-9]*\.[0-9]*|// @version      ${{ env.new_version }}|" "$script_file"
          
          echo "Updated script file content:"
          cat "$script_file"
          
          echo "Updated version to ${{ env.new_version }}"

      - name: Commit and push changes
        run: |
          # 配置 Git 用户
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # 添加更改
          git add "Greasyfork Utility Toolkit.user.js"
          git commit -m "Update version to ${{ env.new_version }}" || echo "No changes to commit"
          git push origin main
        env:
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}  # 传递 Token 到 Git 环境变量中
